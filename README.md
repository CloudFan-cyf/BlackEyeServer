# 北京大学智能电子系统设计与实践课程项目：BlackEye
## 项目概述
本项目为北京大学智能电子系统设计与实践课程项目，本仓库为Nodejs服务端部分。BlackEye旨在复刻《RainbowSix:Siege》游戏中Valkyrie干员的技能：“黑眼”摄像头。
在游戏中，“黑眼”摄像头是一个信息获取道具（[技能演示视频](https://markdown.com.cn)）；在我们复刻的过程中，希望让它具有更生活化的功能，最终设定为家庭场景下的安防摄像头应用。<br>

## 代码逻辑
Nodejs服务端主要功能分为两部分：
+ 处理登录和注册请求：对来自用户的登录请求(`/login`)，验证其用户名和密码是否在SQLite数据库文件中(`database.sqlite`，如果不存在将被创建)，如果是，则通过JWT下发toke供用户登录；反之则返回登录错误信息。对来自用户的注册请求(`/register`)，验证其提供的`SECRET_KEY`是否正确，如果是，则在数据库文件中添加该用户信息并返回注册成功信息。
+ 处理WebSocket连接和消息：对持有正确token的路径为`/user`的连接请求，建立WebSocket连接，反之则销毁连接；对路径为`/esp32`的连接请求，直接建立连接。对来自`/esp32`的连接会持续监听其消息，一旦接收到消息直接将其转发给所有已连接的用户。对来自`/user`的连接会检测连接数量，在连接数为1的时候向ESP32发送`wake`消息，唤醒摄像头；在连接数为0的时候向ESP32发送`sleep`消息，令摄像头休眠。对来自用户端的消息（只有控制消息这一种类型），会先将其转换为字符串再转发。

## 使用说明
### 修改注册密钥
在您向自己的公网服务器上部署该Nodejs代码时，您可以自定义注册使用的密钥：
```
const SECRET_KEY = 'BlackEYEBYCyf&Qp';
```
将该密钥改为您自己的密钥。<br>
### 修改监听端口
请您根据自己服务器的开放端口修改Nodejs服务端监听的端口：
```
server.listen(5901, () => {
    console.log('Server is listening on port 5901');
});
```
请将`5901`修改为您自己可用的端口号。

